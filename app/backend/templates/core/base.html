<!--
=========================================================
Material Kit - v2.0.7
=========================================================

Product Page: https://www.creative-tim.com/product/material-kit
Copyright 2020 Creative Tim (https://www.creative-tim.com/)

Coded by Creative Tim

=========================================================

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" type="image/png" href="/static/favicon.ico" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
      {% block title_head %}{{ self.title }}{% if self.description %} | {{ self.description }}{% endif %}{% endblock %} | Positive Farms
    </title>
    <meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport' />

    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Round|Material+Icons+Sharp" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    <!-- CSS Files -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">   
    <link href="/static/material-kit/css/material-kit.css" rel="stylesheet" />
    <link href="/static/material-kit/bootstrap-select/css/bootstrap-select.css" rel="stylesheet" />
    <link href="/static/css/custom.css" rel="stylesheet" />
    <link href="/static/css/mapbox-gl-draw.css" rel="stylesheet" />
    <link href='/static/css/maplibre-gl.css' rel="stylesheet" />
    <script src="/static/js/jquery-1.7.1.min.js"></script>
    <script src='/static/js/maplibre-gl.js'></script>
    <script src="/static/js/turf.min.js"></script>
    <script src="/static/js/polygon-clipping.umd.min.js"></script>
    <script src="/static/js/mapbox-gl-draw.js"></script>
    

    <style>

    .navbar .navbar-brand {      
        height:80px;
    }

    .maplibregl-style-list {
      display: none;
    }

    .maplibregl-ctrl-group .maplibregl-style-list button {
      background: none;
      border: none;
      cursor: pointer;
      display: block;
      font-size: 14px;
      padding: 8px 8px 6px;
      text-align: right;
      width: 100%;
      height: auto;
    }

    .maplibregl-style-list button.active {
      font-weight: bold;
    }

    .maplibregl-style-list button:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .maplibregl-style-list button + button {
      border-top: 1px solid #ddd;
    }

    .maplibregl-style-switcher {
      background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IiB3aWR0aD0iNTQuODQ5cHgiIGhlaWdodD0iNTQuODQ5cHgiIHZpZXdCb3g9IjAgMCA1NC44NDkgNTQuODQ5IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1NC44NDkgNTQuODQ5OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PGc+PGc+PGc+PHBhdGggZD0iTTU0LjQ5NywzOS42MTRsLTEwLjM2My00LjQ5bC0xNC45MTcsNS45NjhjLTAuNTM3LDAuMjE0LTEuMTY1LDAuMzE5LTEuNzkzLDAuMzE5Yy0wLjYyNywwLTEuMjU0LTAuMTA0LTEuNzktMC4zMThsLTE0LjkyMS01Ljk2OEwwLjM1MSwzOS42MTRjLTAuNDcyLDAuMjAzLTAuNDY3LDAuNTI0LDAuMDEsMC43MTZMMjYuNTYsNTAuODFjMC40NzcsMC4xOTEsMS4yNTEsMC4xOTEsMS43MjksMEw1NC40ODgsNDAuMzNDNTQuOTY0LDQwLjEzOSw1NC45NjksMzkuODE3LDU0LjQ5NywzOS42MTR6Ii8+PHBhdGggZD0iTTU0LjQ5NywyNy41MTJsLTEwLjM2NC00LjQ5MWwtMTQuOTE2LDUuOTY2Yy0wLjUzNiwwLjIxNS0xLjE2NSwwLjMyMS0xLjc5MiwwLjMyMWMtMC42MjgsMC0xLjI1Ni0wLjEwNi0xLjc5My0wLjMyMWwtMTQuOTE4LTUuOTY2TDAuMzUxLDI3LjUxMmMtMC40NzIsMC4yMDMtMC40NjcsMC41MjMsMC4wMSwwLjcxNkwyNi41NiwzOC43MDZjMC40NzcsMC4xOSwxLjI1MSwwLjE5LDEuNzI5LDBsMjYuMTk5LTEwLjQ3OUM1NC45NjQsMjguMDM2LDU0Ljk2OSwyNy43MTYsNTQuNDk3LDI3LjUxMnoiLz48cGF0aCBkPSJNMC4zNjEsMTYuMTI1bDEzLjY2Miw1LjQ2NWwxMi41MzcsNS4wMTVjMC40NzcsMC4xOTEsMS4yNTEsMC4xOTEsMS43MjksMGwxMi41NDEtNS4wMTZsMTMuNjU4LTUuNDYzYzAuNDc3LTAuMTkxLDAuNDgtMC41MTEsMC4wMS0wLjcxNkwyOC4yNzcsNC4wNDhjLTAuNDcxLTAuMjA0LTEuMjM2LTAuMjA0LTEuNzA4LDBMMC4zNTEsMTUuNDFDLTAuMTIxLDE1LjYxNC0wLjExNiwxNS45MzUsMC4zNjEsMTYuMTI1eiIvPjwvZz48L2c+PC9nPjxnPjwvZz48Zz48L2c+PGc+PC9nPjxnPjwvZz48Zz48L2c+PGc+PC9nPjxnPjwvZz48Zz48L2c+PGc+PC9nPjxnPjwvZz48Zz48L2c+PGc+PC9nPjxnPjwvZz48Zz48L2c+PGc+PC9nPjwvc3ZnPg==);
      background-position: center;
      background-repeat: no-repeat;
      background-size: 70%;
    }

    .maplibregl-upload {
      background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIj8+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMjIsMTNhMSwxLDAsMCwwLTEsMXY0LjIxM0EyLjc5LDIuNzksMCwwLDEsMTguMjEzLDIxSDUuNzg3QTIuNzksMi43OSwwLDAsMSwzLDE4LjIxM1YxNGExLDEsMCwwLDAtMiwwdjQuMjEzQTQuNzkyLDQuNzkyLDAsMCwwLDUuNzg3LDIzSDE4LjIxM0E0Ljc5Miw0Ljc5MiwwLDAsMCwyMywxOC4yMTNWMTRBMSwxLDAsMCwwLDIyLDEzWiIvPjxwYXRoIGQ9Ik02LjcwNyw4LjcwNywxMSw0LjQxNFYxN2ExLDEsMCwwLDAsMiwwVjQuNDE0bDQuMjkzLDQuMjkzYTEsMSwwLDAsMCwxLjQxNC0xLjQxNGwtNi02YTEsMSwwLDAsMC0xLjQxNCwwbC02LDZBMSwxLDAsMCwwLDYuNzA3LDguNzA3WiIvPjwvc3ZnPgo=);
      background-position: center;
      background-repeat: no-repeat;
      background-size: 70%;
    }

    .maplibregl-selector {
      background-image: url(data:image/svg+xml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgaGVpZ2h0PSI1MTIiIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNTEyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGRhdGEtbmFtZT0iTGF5ZXIgMSI+PHBhdGggZD0ibTQ5My41MTcgMTkuOTM5LTEuNDU2LTEuNDU2YTYzLjEwNiA2My4xMDYgMCAwIDAgLTg5LjI0NSAwbC0xMDEuMzM5IDEwMS4zNC03Ljc0NS03Ljc0NWEyMC40NzggMjAuNDc4IDAgMCAwIC0yOC45NiAwbC0uNDczLjQ3M2EyMC40NzggMjAuNDc4IDAgMCAwIDAgMjguOTZsMTEuOTc0IDExLjk3NC0yMTcuMDE2IDIxNy4wMTVhMTI0LjgyOCAxMjQuODI4IDAgMCAwIC0yOC44NTcgNDUuNDA4bC0yNy4zNDQgNTAuMzYyYTI0LjI3IDI0LjI3IDAgMCAwIC0yLjk1NiA5LjQ3OWMtLjc2NiA5LjAxMiAyLjkgMTguNzEzIDEwLjE2OCAyNS45ODJzMTYuOTcxIDEwLjkzNSAyNS45ODMgMTAuMTY5YTI0LjI3NSAyNC4yNzUgMCAwIDAgOS40NzktMi45NTZsNTAuMzYxLTI3LjM0NGExMjQuODUgMTI0Ljg1IDAgMCAwIDQ1LjQwOS0yOC44NTdsMjE3LjAxNS0yMTcuMDE3IDExLjk3NCAxMS45NzRhMjAuNDc2IDIwLjQ3NiAwIDAgMCAyOC45NiAwbC40NzMtLjQ3MmEyMC40NzggMjAuNDc4IDAgMCAwIDAtMjguOTZsLTcuNzQ1LTcuNzQ1IDEwMS4zNC0xMDEuMzM5YTYzLjEwNiA2My4xMDYgMCAwIDAgMC04OS4yNDV6bS0zNzIuMTE3IDQyMy4wMThhODYuMTE2IDg2LjExNiAwIDAgMSAtMjcuMTY3IDE4LjMyOCA4Ny4yNDcgODcuMjQ3IDAgMCAwIC0xMS4wNjEgNS44bC0zNC43MjEgMjEuMTgxYTE4LjMyNCAxOC4zMjQgMCAwIDEgLTIwLjg5NC0yLjEzMXEtLjQ0NC0uNC0uODctLjgyMmMtLjI4NS0uMjg0LS41NTktLjU3NS0uODIzLS44N2ExOC4zMjcgMTguMzI3IDAgMCAxIC0yLjEzMS0yMC44OTVsMjEuMTgzLTM0LjcyMWE4Ny41MTMgODcuNTEzIDAgMCAwIDUuOC0xMS4wNjEgODYuMDcyIDg2LjA3MiAwIDAgMSAxOC4zMjgtMjcuMTY2bDIyMS42NC0yMjEuNjQgNTIuMzU4IDUyLjM1OHoiLz48L3N2Zz4=);
      background-position: center;
      background-repeat: no-repeat;
      background-size: 70%;
    }

    .maplibregl-fitbounds {
      background-image: url(data:image/svg+xml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTI4IDEyOCIgaGVpZ2h0PSI1MTIiIHZpZXdCb3g9IjAgMCAxMjggMTI4IiB3aWR0aD0iNTEyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGlkPSJNYXhpbWl6ZSIgZD0ibTExNiAxNnYyNGMwIDIuMjA5LTEuNzkxIDQtNCA0cy00LTEuNzkxLTQtNHYtMTQuMzQ0bC0yNS4xNzIgMjUuMTcyYy0uNzgxLjc4MS0xLjgwNSAxLjE3Mi0yLjgyOCAxLjE3MnMtMi4wNDctLjM5MS0yLjgyOC0xLjE3MmMtMS41NjMtMS41NjMtMS41NjMtNC4wOTQgMC01LjY1NmwyNS4xNzItMjUuMTcyaC0xNC4zNDRjLTIuMjA5IDAtNC0xLjc5MS00LTRzMS43OTEtNCA0LTRoMjRjMi4yMDkgMCA0IDEuNzkxIDQgNHptLTY1LjE3MiAyOS4xNzItMjUuMTcyLTI1LjE3MmgxNC4zNDRjMi4yMDkgMCA0LTEuNzkxIDQtNHMtMS43OTEtNC00LTRoLTI0Yy0yLjIwOSAwLTQgMS43OTEtNCA0djI0YzAgMi4yMDkgMS43OTEgNCA0IDRzNC0xLjc5MSA0LTR2LTE0LjM0NGwyNS4xNzIgMjUuMTcyYy43ODEuNzgxIDEuODA1IDEuMTcyIDIuODI4IDEuMTcyczIuMDQ3LS4zOTEgMi44MjgtMS4xNzJjMS41NjMtMS41NjIgMS41NjMtNC4wOTQgMC01LjY1NnptNjEuMTcyIDM4LjgyOGMtMi4yMDkgMC00IDEuNzkxLTQgNHYxNC4zNDRsLTI1LjE3Mi0yNS4xNzJjLTEuNTYzLTEuNTYzLTQuMDk0LTEuNTYzLTUuNjU2IDBzLTEuNTYzIDQuMDk0IDAgNS42NTZsMjUuMTcyIDI1LjE3MmgtMTQuMzQ0Yy0yLjIwOSAwLTQgMS43OTEtNCA0czEuNzkxIDQgNCA0aDI0YzIuMjA5IDAgNC0xLjc5MSA0LTR2LTI0YzAtMi4yMDktMS43OTEtNC00LTR6bS02MS4xNzItNi44MjhjLTEuNTYzLTEuNTYzLTQuMDk0LTEuNTYzLTUuNjU2IDBsLTI1LjE3MiAyNS4xNzJ2LTE0LjM0NGMwLTIuMjA5LTEuNzkxLTQtNC00cy00IDEuNzkxLTQgNHYyNGMwIDIuMjA5IDEuNzkxIDQgNCA0aDI0YzIuMjA5IDAgNC0xLjc5MSA0LTRzLTEuNzkxLTQtNC00aC0xNC4zNDRsMjUuMTcyLTI1LjE3MmMxLjU2My0xLjU2MiAxLjU2My00LjA5NCAwLTUuNjU2eiIvPjwvc3ZnPg==);
      background-position: center;
      background-repeat: no-repeat;
      background-size: 70%;
    }

    .maplibregl-inverted {
        background-color: #AAA;
    }

  </style>

  </head>

  {% load templatetags %}

  {% expr (request.path == '/accounts/login/') as islogin %}
  {% expr (request.path == '/signup/') as issignup %}
  {% expr (request.path == '/account/') as ishomepage %}
  {% expr (islogin or issignup) as transparentnavbar %}

  <body class="{% if islogin %}signup-page loginspecial-page{% elif issignup %}signup-page{% else %}sections-page{% endif %} sidebar-collapse">

    <nav class="navbar navbar-expand-lg noshadow" style="-webkit-box-shadow: none!important;-moz-box-shadow: none!important;box-shadow: none!important;" id="sectionsNav">

      <div class="container">
        <div class="navbar-translate">
          <a class="navbar-brand" style="font-size:28px;" href="/"><img width="120" alt="Positive Farms" title="Positive Farms" class="positivefarms-logo"  src="/static/assets/media/logo-positivefarms-black.png"/></a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon"></span>
            <span class="navbar-toggler-icon"></span>
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>

        <div class="collapse navbar-collapse">

          <ul class="navbar-nav ml-auto">

	

            <li class="nav-item ">
                <a class="nav-link " href="/">Map</a>
                
            </li>       

<!--            
            <li class="nav-item ">
                <a class="nav-link " href="/methods/">Methods</a>
                
            </li>       
          
            <li class="nav-item ">
                <a class="nav-link " href="/contact/">Contact</a>
                
            </li>       

-->
	
        
<li class="dropdown nav-item">
	<a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown" aria-expanded="false">
	  <i class="material-icons mdi-36px {% if user.is_authenticated %} groovy-connected{% else %} groovy-disconnected{% endif %}">account_circle</i> {% if user.is_authenticated %}Logged in as <b>{{ user.username}}</b>{% else %}Login{% endif %} 
	<div class="ripple-container"></div></a>
	<div class="dropdown-menu dropdown-with-icons">

{% if user.is_authenticated %}

		<a class="dropdown-item" href="{% url 'logout' %}"><i class="material-icons">exit_to_app</i> Logout</a>

{% else %}

		<a class="dropdown-item" href="{% url 'login' %}"><i class="material-icons">lock_open</i> Login</a>
		<a class="dropdown-item" href="{% url 'signup' %}"><i class="material-icons">person_add</i> Register</a>
	
{% endif %}
</div>

</li>

        
        </ul>

        </div>
      </div>

    </nav>

    {% block supermain %}

    <div class="main">
      <div>
        {% block carousel %}
        {% endblock %}
      </div>

      <div class="container maincontent">

          {% block content %}          
          {% endblock %}

      </div>

      {% block local_footer %}
      {% block footer %}
          {% include 'core/footer.html' %}
      {% endblock %}
      {% endblock %}
      
    </div>

    {% endblock %}  

    <!--   Core JS Files   -->
    <script src="/static/material-kit/js/core/jquery.min.js" type="text/javascript"></script>
    <script src="/static/material-kit/js/core/popper.min.js" type="text/javascript"></script>
    <script src="/static/material-kit/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
    <script src="/static/material-kit/js/plugins/moment.min.js"></script>
    <!--	Plugin for the Datepicker, full documentation here: https://github.com/Eonasdan/bootstrap-datetimepicker -->
    <script src="/static/material-kit/js/plugins/bootstrap-datetimepicker.js" type="text/javascript"></script>
    <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
    <script src="/static/material-kit/js/plugins/nouislider.min.js" type="text/javascript"></script>
    <!--	Plugin for Select, full documentation here: http://silviomoreto.github.io/bootstrap-select -->
    <script src="/static/material-kit/bootstrap-select/js/bootstrap-select.js" type="text/javascript"></script>
    <!-- Control Center for Material Kit: parallax effects, scripts for the example pages etc -->
    <script src="/static/material-kit/js/material-kit.js?v=2.0.7" type="text/javascript"></script>

    <script src="/static/tinymce/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!-- Plugin for input masks that works for mobiles -->
    <script src="/static/js/jquery.mask.min.js" type="text/javascript"></script>
        
    <script type="text/javascript">

      tinymce.init({
        selector: '.tinymce',
        menubar: false,
        height: 300,
        plugins: 'lists',
        toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright alignjustify | outdent indent | numlist bullist'
      });

      function postcodeChanged() {
        console.log("postcode changed");
      }

      var postcode = '';

      function isValidPostcode(p) { 
          if (p !== undefined) {
            p = p.trim();
            var postcodeRegEx = /^[A-Z]{1,2}[0-9]{1,2} ?[0-9][A-Z]{2}$/i; 
            return postcodeRegEx.test(p); 
          }
      }

      function setGotoPostcode() {
        $('#goto-postcode').html('or <span style="cursor:pointer" id="goto-postcode" onClick="gotoPostcode()"><b>goto postcode</b></span>');
      }

      function clearGotoPostcode() {
        $('#goto-postcode').html('');
      }

      $('input[name=postcode]').on("input", function (changeEvent) {
        if (changeEvent.target.value != postcode) {
          postcode = changeEvent.target.value;
          if (isValidPostcode(postcode)) {
            setGotoPostcode();
          } else {
            clearGotoPostcode();
          }
        }
        return false;
      });

      if (isValidPostcode($('input[name=postcode]').val())) {
        setGotoPostcode();
      } else {
        clearGotoPostcode();
      }

      function gotoPostcode() {
        var postcode = $('input[name=postcode]').val().trim();
        if (postcode !== '') {
          $(document).ready(function () {
            $.ajax({ 
                type: 'GET', 
                url: '/locationposition', 
                data: { location: postcode }, 
                success: function (data) {
                  map.jumpTo({center: [data.data['lng'], data.data['lat']], zoom: data.data['zoom']});
                }
            });
          });
        }
        return false;
      }

      function getRasterStyle(url, attribution, invert) {
          var defaultColor = "black";
          if (invert) defaultColor = "white";

          return {
              'version': 8,
              'sources': {
                  'background': {
                      'type': 'raster',
                      'tiles': [url],
                      'tileSize': 256,
                      'attribution': attribution
                  },
                  "inspire": {
                      "type": "vector",
                      "url": "https://tiles.positivefarms.org/data/inspire.json",
                      "attribution": "INSPIRE polygons data subject to Crown Copyright and database rights 2023 and is reproduced with the permission of HM Land Registry and Ordnance Survey 100026316"
                  },      
              },
              'layers': [
                  {
                      'id': 'background',
                      'type': 'raster',
                      'source': 'background',
                      'minzoom': 0,
                      'maxzoom': 22
                  },
                  {
                      "id": "inspire_outlined",
                      "type": "line",
                      "source": "inspire",
                      "source-layer": "inspire",
                      "filter": [
                          "all"
                      ],
                      "paint": {
                          "line-color": defaultColor,
                          "line-width": [
                          "case",
                          ["boolean", ["feature-state", "hover"], false],
                          3,
                          1
                          ],
                          "line-opacity": [
                          "case",
                          ["boolean", ["feature-state", "hover"], false],
                          1,
                          0.1
                          ]          
                      }
                  },
                  {
                      "id": "inspire_filled",
                      "type": "fill",
                      "source": "inspire",
                      "source-layer": "inspire",
                      "filter": [
                          "all"
                      ],
                      "paint": {
                          "fill-color": 'white',
                          "fill-opacity": 0                       
                      }
                  }
              ]
          };
      }

      class MapLibreStyleSwitcherControl {

          constructor(styles, defaultStyle) {
              this.styles = styles;
              this.defaultStyle = defaultStyle;
              this.onDocumentClick = this.onDocumentClick.bind(this);
          }

          getDefaultPosition() {
              const defaultPosition = "top-right";
              return defaultPosition;
          }

          onAdd(map) {
              this.map = map;
              this.controlContainer = document.createElement("div");
              this.controlContainer.title = "Change background layer";
              this.controlContainer.classList.add("maplibregl-ctrl");
              this.controlContainer.classList.add("maplibregl-ctrl-group");
              this.mapStyleContainer = document.createElement("div");
              this.styleButton = document.createElement("button");
              this.styleButton.type = "button";
              this.mapStyleContainer.classList.add("maplibregl-style-list");
              for (const style of this.styles) {
                  const styleElement = document.createElement("button");
                  styleElement.type = "button";
                  styleElement.innerText = style.title;
                  styleElement.classList.add(
                  style.title.replace(/[^a-z0-9-]/gi, "_")
                  );
                  styleElement.dataset.style = JSON.stringify(style.style);
                  styleElement.addEventListener("click", (event) => {
                  const srcElement = event.srcElement;
                  if (srcElement.classList.contains("active")) {
                      return;
                  }
                  this.map.setStyle(JSON.parse(srcElement.dataset.style));
                  this.mapStyleContainer.style.display = "none";
                  this.styleButton.style.display = "block";
                  const elms =
                      this.mapStyleContainer.getElementsByClassName("active");
                  while (elms[0]) {
                      elms[0].classList.remove("active");
                  }
                  srcElement.classList.add("active");
                  });
                  if (style.title === this.defaultStyle) {
                  styleElement.classList.add("active");
                  }
                  this.mapStyleContainer.appendChild(styleElement);
              }
              this.styleButton.classList.add("maplibregl-ctrl-icon");
              this.styleButton.classList.add("maplibregl-style-switcher");
              this.styleButton.addEventListener("click", () => {
                  this.styleButton.style.display = "none";
                  this.mapStyleContainer.style.display = "block";
              });
              document.addEventListener("click", this.onDocumentClick);
              this.controlContainer.appendChild(this.styleButton);
              this.controlContainer.appendChild(this.mapStyleContainer);
              return this.controlContainer;
          }

          onRemove() {
              if (
                  !this.controlContainer ||
                  !this.controlContainer.parentNode ||
                  !this.map ||
                  !this.styleButton
              ) {
                  return;
              }
              this.styleButton.removeEventListener("click", this.onDocumentClick);
              this.controlContainer.parentNode.removeChild(this.controlContainer);
              document.removeEventListener("click", this.onDocumentClick);
              this.map = undefined;
          }

          onDocumentClick(event) {
              if (
                  this.controlContainer &&
                  !this.controlContainer.contains(event.target) &&
                  this.mapStyleContainer &&
                  this.styleButton
              ) {
                  this.mapStyleContainer.style.display = "none";
                  this.styleButton.style.display = "block";
              }
          }
      }

      class MapLibreUploadControl {

          constructor() {
              this.onDocumentClick = this.onDocumentClick.bind(this);
          }

          getDefaultPosition() {
              const defaultPosition = "top-right";
              return defaultPosition;
          }

          onAdd(map) {
              this.map = map;
              this.controlContainer = document.createElement("div");
              this.controlContainer.title = "Upload GeoJSON file";
              this.controlContainer.classList.add("maplibregl-ctrl");
              this.controlContainer.classList.add("maplibregl-ctrl-group");
              this.uploadButton = document.createElement("button");
              this.uploadButton.type = "button";
              this.uploadButton.classList.add("maplibregl-ctrl-icon");
              this.uploadButton.classList.add("maplibregl-upload");
              this.uploadButton.addEventListener("click", () => {
                  $('input[type=file]').trigger('click');
              });
              document.addEventListener("click", this.onDocumentClick);
              this.controlContainer.appendChild(this.uploadButton);
              return this.controlContainer;
          }

          onRemove() {
              if (
                  !this.controlContainer ||
                  !this.controlContainer.parentNode ||
                  !this.map ||
                  !this.uploadButton
              ) {
                  return;
              }
              this.uploadButton.removeEventListener("click", this.onDocumentClick);
              this.controlContainer.parentNode.removeChild(this.controlContainer);
              document.removeEventListener("click", this.onDocumentClick);
              this.map = undefined;
          }

          onDocumentClick(event) {
              if (
                  this.controlContainer &&
                  !this.controlContainer.contains(event.target) &&
                  this.uploadButton
              ) {
                  this.uploadButton.style.display = "block";
              }
          }
      }

      $("#fileuploaded").on("change", function (changeEvent) {
        const file = changeEvent.target.files[0]; 
          const reader = new FileReader();

          reader.onload = function (theFile) {
              const geoJSONcontent = JSON.parse(theFile.target.result);
              existingdata = draw.getAll();
              var newfeaturecollection = {'type': 'FeatureCollection', 'features': []};
              for (const [newkey, newvalue] of Object.entries(geoJSONcontent['features'])) {
                  var notinexistence = true;
                  newvalue['id'] = 0;
                  for (const [existingkey, existingvalue] of Object.entries(existingdata['features'])) {
                      existingvalue['id'] = 0;
                      if (turf.booleanEqual(existingvalue, newvalue)) {
                          console.log("Found existing identical feature, not adding");
                          notinexistence = false;
                          break;
                      }
                  }

                  if (notinexistence === true) {
                      newfeaturecollection['features'].push(newvalue);
                  }
              }

              var featureIds = draw.add(newfeaturecollection);
              data = draw.getAll();
              map.fitBounds(turf.bbox(data), {duration: 0});
              updateGeoJSONField();
              $('#fileuploaded').val('');
          };

          reader.readAsText(file, 'UTF-8');
      });

      class MapLibreSelectorControl {

          constructor() {
              this.onDocumentClick = this.onDocumentClick.bind(this);
          }

          getDefaultPosition() {
              const defaultPosition = "top-right";
              return defaultPosition;
          }

          onAdd(map) {
              this.map = map;
              this.controlContainer = document.createElement("div");
              this.controlContainer.title = "Select existing map boundaries";
              this.controlContainer.classList.add("maplibregl-ctrl");
              this.controlContainer.classList.add("maplibregl-ctrl-group");
              this.controlContainer.classList.add("mapselector");
              this.uploadButton = document.createElement("button");
              this.uploadButton.type = "button";
              this.uploadButton.classList.add("maplibregl-ctrl-icon");
              this.uploadButton.classList.add("maplibregl-selector");
              this.uploadButton.addEventListener("click", (e) => {
                  selectorEnabled = !selectorEnabled;
                  if (selectorEnabled) {
                      $('.mapselector').addClass('maplibregl-inverted');
                      
                      if (map.getZoom() < selectorMinZoom) {
                          map.setZoom(selectorMinZoom);
                          map.setMinZoom(selectorMinZoom);
                      }
                  } else {
                      $('.mapselector').removeClass('maplibregl-inverted');
                      removeCurrentHovered();
                      map.setMinZoom(5);
                  }
              });
              document.addEventListener("click", this.onDocumentClick);
              this.controlContainer.appendChild(this.uploadButton);
              return this.controlContainer;
          }

          onRemove() {
              if (
                  !this.controlContainer ||
                  !this.controlContainer.parentNode ||
                  !this.map ||
                  !this.uploadButton
              ) {
                  return;
              }
              this.uploadButton.removeEventListener("click", this.onDocumentClick);
              this.controlContainer.parentNode.removeChild(this.controlContainer);
              document.removeEventListener("click", this.onDocumentClick);
              this.map = undefined;
          }

          onDocumentClick(event) {
              if (
                  this.controlContainer &&
                  !this.controlContainer.contains(event.target) &&
                  this.uploadButton
              ) {
                  this.uploadButton.style.display = "block";
              }
          }
      }        

      class MapLibreFitBoundsControl {

          constructor() {
              this.onDocumentClick = this.onDocumentClick.bind(this);
          }

          getDefaultPosition() {
              const defaultPosition = "top-right";
              return defaultPosition;
          }

          onAdd(map) {
              this.map = map;
              this.controlContainer = document.createElement("div");
              this.controlContainer.title = "Fit created objects to window";
              this.controlContainer.classList.add("maplibregl-ctrl");
              this.controlContainer.classList.add("maplibregl-ctrl-group");
              this.fitBoundsButton = document.createElement("button");
              this.fitBoundsButton.type = "button";
              this.fitBoundsButton.classList.add("maplibregl-ctrl-icon");
              this.fitBoundsButton.classList.add("maplibregl-fitbounds");
              this.fitBoundsButton.addEventListener("click", (e) => {
                  var elements = draw.getAll();
                  if (elements.features.length > 0) {
                      map.fitBounds(turf.bbox(elements), {duration: 0});
                  }
              });
              document.addEventListener("click", this.onDocumentClick);
              this.controlContainer.appendChild(this.fitBoundsButton);
              return this.controlContainer;
          }

          onRemove() {
              if (
                  !this.controlContainer ||
                  !this.controlContainer.parentNode ||
                  !this.map ||
                  !this.fitBoundsButton
              ) {
                  return;
              }
              this.fitBoundsButton.removeEventListener("click", this.onDocumentClick);
              this.controlContainer.parentNode.removeChild(this.controlContainer);
              document.removeEventListener("click", this.onDocumentClick);
              this.map = undefined;
          }

          onDocumentClick(event) {
              if (
                  this.controlContainer &&
                  !this.controlContainer.contains(event.target) &&
                  this.fitBoundsButton
              ) {
                  this.fitBoundsButton.style.display = "block";
              }
          }
      }    

      var styles = (MapLibreStyleDefinition = [
          {
              title: "Open Street Map - Clean",
              style: 'https://tiles.positivefarms.org/styles/inspire/style.json'
          },
          {
              title: "Open Street Map - Detailed",
              style: getRasterStyle(  'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
                                      'Open Street Map data &copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors', false)
          },
          {
              title: "Google Satellite",
              style: getRasterStyle(  'https://www.google.com/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}',
                                      'Imagery ©2023 Google, Imagery ©2023 Bluesky, Getmapping plc, Infoterra Ltd & Bluesky, Maxar Technologies, Map data ©2023', true)
          },
      ]);

      function merge (inputs) {

          const output = {
              id: inputs[0].id,
              type: inputs[0].type,
              geometry: {
                  coordinates: polygonClipping.union(...inputs.map(i => i.geometry.coordinates)),
                  type: 'MultiPolygon'
              },
              properties: inputs[0].properties
          }
          return output;
      }

      function initiateArea(geoJSON) {
          draw.add(geoJSON);
          map.fitBounds(turf.bbox(geoJSON), {duration: 0});
      }

      function updateArea(e) {
        updateGeoJSONField();
      }

      function updateGeoJSONField() {
        const data = draw.getAll();
        $('#id_GeoJSON').val(JSON.stringify(data, null, 2));
      }

      const draw = new MapboxDraw({
          class: 'draw', 
          displayControlsDefault: false,
          controls: {
              polygon: true,
              trash: true
          },
      });


      var selectorEnabled = false;
      var selectorMinZoom = 11;
      var hoveredStateId = null;    
      var map;

      if ($('#map').length) {

        var field_location = document.getElementById('field_location');
        var field_featurecollection = document.getElementById('field_featurecollection');
        var initPos = [-3.7140953311984504, 53.9299491635351];
        var initZoom = 4.34;

        if (JSON.stringify(field_location) !== 'null') {
          field_location = JSON.parse(field_location.text);
          initPos = [field_location[1], field_location[0]];
          initZoom = 13;
        }

        map = new maplibregl.Map({
            container: 'map',
            style: styles[0].style, 
            center: initPos, 
            zoom: initZoom,
            interactiveLayerIds: ['inspire_outlined']         
        });

        map.on('load', function() {
            map.dragRotate.disable();
            map.touchZoomRotate.disableRotation();        
            map.addControl(draw, 'top-right');
            map.addControl(new MapLibreSelectorControl());
            map.addControl(new MapLibreUploadControl());
            map.addControl(new MapLibreFitBoundsControl());
            map.addControl(new MapLibreStyleSwitcherControl(styles, styles[0]['title']));
            map.addControl(new maplibregl.NavigationControl());        
            map.addControl(
            new maplibregl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true
            }));

            map.on('draw.create', updateArea);
            map.on('draw.delete', updateArea);
            map.on('draw.update', updateArea);
            $('.mapboxgl-ctrl-group').addClass('maplibregl-ctrl maplibregl-ctrl-group');

            if (JSON.stringify(field_featurecollection) !== 'null') {
              var featurecollection = field_featurecollection.text.trim();
              if (featurecollection !== '') {
                featurecollection = JSON.parse(JSON.parse(featurecollection));
                draw.add(featurecollection);
                data = draw.getAll();
                map.fitBounds(turf.bbox(data), {duration: 0});
                updateGeoJSONField();
              }
            }

            map.on('mousemove', 'inspire_filled', (e) => {
                if (!selectorEnabled) return;

                if (e.features.length > 0) {
                    newHoveredStateId = e.features[0].id;
                    if (newHoveredStateId != hoveredStateId) {
                        if (hoveredStateId !== null) {
                            removeCurrentHovered();
                        }

                        hoveredStateId = newHoveredStateId;
                        map.setFeatureState(
                            {source: 'inspire', sourceLayer: 'inspire', id: hoveredStateId},
                            {hover: true}
                        );

                    }
                }
            });

            removeCurrentHovered = () => {
                map.setFeatureState(
                    {source: 'inspire', sourceLayer: 'inspire', id: hoveredStateId},
                    {hover: false}
                );
                hoveredStateId = null;
            }

            map.on('mouseleave', 'inspire_outlined', () => {
                if (hoveredStateId) {
                    removeCurrentHovered();
                }
            });

            map.on('click', 'inspire_filled', (e) => {
                // Thanks to https://github.com/mapbox/mapbox-gl-js/issues/5639
                if (selectorEnabled) {
                    const features = map.queryRenderedFeatures(e.point);
                    if (features.length) {
                        if (features[0].properties.INSPIREID !== undefined) {
                            const sourceFeatures = map.querySourceFeatures(features[0].source, {
                                sourceLayer: features[0].sourceLayer,
                                filter: ["==", 'INSPIREID', features[0].properties.INSPIREID ]
                            })
                            const originalFeature = merge(sourceFeatures);
                            draw.add(originalFeature);
                            updateGeoJSONField();
                        }
                    }
                }
            });

        });

      }



    </script>

  </body>
</html>